{"paragraphs":[{"text":"%pyspark\n\n# Zeppelin notebook to extract host and in/out-link examples for each of the PLDs in the CommonCrawl webgraph\n# Complements summaries produced in 'Paul 5', and gets combined with these in 'Paul 7'.\n# Recomended config for complete run: 4xr4.8xlarge, and set spark.driver.maxResultSize to 16g\n# PJ - 1 December 2017\n\nimport boto\nfrom pyspark.sql.types import *\n\n# Load the saved files from Paul 5.\n#loadURI=\"s3://billsdata.net/CommonCrawl/hyperlinkgraph/cc-main-2017-may-jun-jul/domaingraph/vertices/\"\nloadURI=\"s3://billsdata.net/CommonCrawl/hyperlinkgraph/cc-main-2017-aug-sep-oct/domaingraph/vertices/\"\npld_df_tmp=spark.read.load(loadURI) #.limit(100) #.repartition(256)\npld_df=pld_df_tmp.select(pld_df_tmp.ID.cast(\"long\"),pld_df_tmp.PLD) # Cast IDs from String to LongInt\npld_df.show(3)\npld_df.cache()\n#print(pld_df.count()) # Should have 91M domains","user":"anonymous","dateUpdated":"2017-12-01T16:27:59+0000","config":{"colWidth":12,"editorMode":"ace/mode/python","results":{},"enabled":true,"editorSetting":{"language":"python","editOnDblClick":false}},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"+---+-----+\n| ID|  PLD|\n+---+-----+\n|  0|aaa.1|\n|  1|aaa.2|\n|  2|aaa.3|\n+---+-----+\nonly showing top 3 rows\n\nDataFrame[ID: bigint, PLD: string]\n"}]},"apps":[],"jobName":"paragraph_1512145645970_774147218","id":"20170929-081624_672091334","dateCreated":"2017-12-01T16:27:25+0000","dateStarted":"2017-12-01T16:27:59+0000","dateFinished":"2017-12-01T16:28:03+0000","status":"FINISHED","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:3641"},{"text":"%pyspark\n\n# Firstly, define a reverse domain function\nfrom pyspark.sql.functions import udf\ndef reverse_domain(domain):\n    return '.'.join(reversed(domain.split('.')))\nprint(reverse_domain(\"com.facebook\"))\nudf_reverse_domain = udf(reverse_domain, StringType())\n\n# Create a reversed version of the PLD dataframe\npld_unrev_df=pld_df.withColumn(\"PLD_unrev\", udf_reverse_domain(\"PLD\")).drop(\"PLD\").withColumnRenamed(\"PLD_unrev\", \"PLD\")\npld_unrev_df.show(5)","user":"anonymous","dateUpdated":"2017-12-01T16:28:08+0000","config":{"colWidth":12,"editorMode":"ace/mode/python","results":{},"enabled":true,"editorSetting":{"language":"python","editOnDblClick":false}},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"facebook.com\n+---+-----+\n| ID|  PLD|\n+---+-----+\n|  0|1.aaa|\n|  1|2.aaa|\n|  2|3.aaa|\n|  3|5.aaa|\n|  4|6.aaa|\n+---+-----+\nonly showing top 5 rows\n\n"}]},"apps":[],"jobName":"paragraph_1512145645970_774147218","id":"20171103-111333_867220084","dateCreated":"2017-12-01T16:27:25+0000","dateStarted":"2017-12-01T16:28:08+0000","dateFinished":"2017-12-01T16:28:47+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:3642"},{"text":"%pyspark\n\n# Next import the PLD edges as a DataFrame - i.e. in/out links\n#loadURI=\"s3://billsdata.net/CommonCrawl/hyperlinkgraph/cc-main-2017-may-jun-jul/domaingraph/edges/\"\nloadURI=\"s3://billsdata.net/CommonCrawl/hyperlinkgraph/cc-main-2017-aug-sep-oct/domaingraph/edges/\"\npld_edges_df=spark.read.load(loadURI) #.limit(1000) #.limit(100000000).repartition(8) # TODO: Remove temp limit once avoiding spark context shutdown!!\npld_edges_df.show(3)\npld_edges_df.cache()","user":"anonymous","dateUpdated":"2017-12-01T16:30:30+0000","config":{"colWidth":12,"editorMode":"ace/mode/python","results":{},"enabled":true,"editorSetting":{"language":"python","editOnDblClick":false}},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"+---+--------+\n|src|     dst|\n+---+--------+\n|  8| 9843173|\n| 27| 9843173|\n| 27|79323140|\n+---+--------+\nonly showing top 3 rows\n\nDataFrame[src: bigint, dst: bigint]\n"}]},"apps":[],"jobName":"paragraph_1512145645970_774147218","id":"20170929-095050_1324183281","dateCreated":"2017-12-01T16:27:25+0000","dateStarted":"2017-12-01T16:30:30+0000","dateFinished":"2017-12-01T16:30:34+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:3643"},{"text":"%pyspark\n\n# Join dataframes using fast equi-joins (equivalent to reduceByKey on RDDs) - avoids the need to create and broadcast an ID-PLD dictionary\npld_edges_df1=pld_unrev_df.join(pld_edges_df, pld_unrev_df.ID==pld_edges_df.src).drop(\"ID\").drop(\"src\").withColumnRenamed(\"PLD\",\"PLD_src\") #rdd.union(rdd1).reduceByKey(lambda x,y : x+y)\npld_edges_df1.show(5)\npld_edges_df2=pld_edges_df1.join(pld_unrev_df, pld_edges_df1.dst==pld_unrev_df.ID).drop(\"ID\").drop(\"dst\").withColumnRenamed(\"PLD\", \"PLD_dst\")\npld_edges_df2.show(5)","user":"anonymous","dateUpdated":"2017-12-01T16:33:39+0000","config":{"colWidth":12,"editorMode":"ace/mode/python","results":{},"enabled":true,"editorSetting":{"language":"python","editOnDblClick":false}},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"+-------+--------+\n|PLD_src|     dst|\n+-------+--------+\n|3920.ac|    1944|\n|3920.ac|28208185|\n|atma.ac| 1711485|\n|atma.ac| 5920816|\n|atma.ac| 9861910|\n+-------+--------+\nonly showing top 5 rows\n\n+--------------------+-------+\n|             PLD_src|PLD_dst|\n+--------------------+-------+\n|     vclsoftware.com|  n.aaa|\n|     vclsoftware.com|  t.aaa|\n|         irosaki.com|atma.ac|\n|xn--mgavideo-b1a.com|atma.ac|\n|      solution26.com|atma.ac|\n+--------------------+-------+\nonly showing top 5 rows\n\n"}]},"apps":[],"jobName":"paragraph_1512145645970_774147218","id":"20171103-104722_615033791","dateCreated":"2017-12-01T16:27:25+0000","dateStarted":"2017-12-01T16:33:39+0000","dateFinished":"2017-12-01T16:36:15+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:3644"},{"text":"%pyspark\n\n# Load the host-level graph vertices in the same way\n#saveURI=\"s3://billsdata.net/CommonCrawl/hyperlinkgraph/cc-main-2017-may-jun-jul/hostgraph/vertices/\"\nsaveURI=\"s3://billsdata.net/CommonCrawl/hyperlinkgraph/cc-main-2017-aug-sep-oct/hostgraph/vertices/\"\nhost_df=spark.read.load(saveURI) #.repartition(64)\nhost_df.show(3)\nhost_df.cache()\n#print(host_df.count()) # Should have 1.3B hosts","user":"anonymous","dateUpdated":"2017-12-01T16:33:59+0000","config":{"colWidth":12,"editorMode":"ace/mode/python","results":{},"enabled":true,"editorSetting":{"language":"python","editOnDblClick":false}},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"+------+-----+\n|hostid| host|\n+------+-----+\n|     0|aaa.1|\n|     1|aaa.2|\n|     2|aaa.3|\n+------+-----+\nonly showing top 3 rows\n\nDataFrame[hostid: string, host: string]\n"}]},"apps":[],"jobName":"paragraph_1512145645970_774147218","id":"20170929-095310_1201506389","dateCreated":"2017-12-01T16:27:25+0000","dateStarted":"2017-12-01T16:33:59+0000","dateFinished":"2017-12-01T16:36:18+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:3645"},{"text":"%pyspark\n\n# Debug partitioning of our 3 big dataframes\nprint(pld_df.rdd.getNumPartitions())\nprint(pld_edges_df.rdd.getNumPartitions())\nprint(host_df.rdd.getNumPartitions())","user":"anonymous","dateUpdated":"2017-12-01T16:34:05+0000","config":{"colWidth":12,"editorMode":"ace/mode/python","results":{},"enabled":true,"editorSetting":{"language":"python","editOnDblClick":false}},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"293\n512\n520\n"}]},"apps":[],"jobName":"paragraph_1512145645970_774147218","id":"20171006-161509_1868852031","dateCreated":"2017-12-01T16:27:25+0000","dateStarted":"2017-12-01T16:36:15+0000","dateFinished":"2017-12-01T16:36:18+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:3646"},{"text":"%pyspark\n\n# DON'T DO THIS - KILLS EXECUTOR MEMORY ON SLAVES, AND DOESN'T SCALE!\n\n# Create a dictionary of PLDs (for ID to PLD mapping of in/out links)\n#pld_dict=pld_df.rdd.collectAsMap()\n#print(pld_dict[2])\n\n# Distribute and test\n#pld_dict_distrib=sc.broadcast(pld_dict) # Maybe broadcasting this huge map to the slaves is what's causing them to die!\n#print(pld_dict_distrib.value[2]) # Should be aaa.aaa\nprint(\"Avoided badness...\")","user":"anonymous","dateUpdated":"2017-12-01T16:37:23+0000","config":{"colWidth":12,"editorMode":"ace/mode/python","results":{},"enabled":true,"editorSetting":{"language":"python","editOnDblClick":false}},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"Avoided badness...\n"}]},"apps":[],"jobName":"paragraph_1512145645971_773762469","id":"20171027-121229_2107241041","dateCreated":"2017-12-01T16:27:25+0000","dateStarted":"2017-12-01T16:37:23+0000","dateFinished":"2017-12-01T16:37:23+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:3647"},{"text":"%pyspark\n\n# DON'T DO THIS EITHER...\n\n# Function to lookup and unreverse PLDs\n#from pyspark.sql.functions import udf\n#def reverse_domain_from_ID(id):\n#    domain=pld_dict_distrib.value[id]\n#    #domain=pld_dict[id] # This will be horribly slow since all queries will have to go via the driver but it might work.\n#    return '.'.join(reversed(domain.split('.')))\n#print(reverse_domain_from_ID(2002))\n#udf_reverse_domain_from_ID = udf(reverse_domain_from_ID, StringType())\n\n#  First, create a new edges dataframe consisting of unreversed PLDs\n#pld_edges_df2=pld_edges_df.withColumn(\"src2\",udf_reverse_domain_from_ID(\"src\")).drop(\"src\").withColumn(\"dst2\",udf_reverse_domain_from_ID(\"dst\")).drop(\"dst\")\n##pld_edges_df.unpersist()\n#pld_edges_df2.show(5)\nprint(\"Avoided more badness...\")","user":"anonymous","dateUpdated":"2017-12-01T16:37:25+0000","config":{"colWidth":12,"editorMode":"ace/mode/python","results":{},"enabled":true,"editorSetting":{"language":"python","editOnDblClick":false}},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"Avoided more badness...\n"}]},"apps":[],"jobName":"paragraph_1512145645971_773762469","id":"20170929-095727_1596943627","dateCreated":"2017-12-01T16:27:25+0000","dateStarted":"2017-12-01T16:37:25+0000","dateFinished":"2017-12-01T16:37:25+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:3648"},{"text":"%pyspark\n\n# Save this new edges dataframe for future use in parquet format, so we can reload later without having the big dict in memory!\n#edgesURI=\"s3://billsdata.net/CommonCrawl/domain_examples_new_edges5/\"\n#pld_edges_df2.write.save(edgesURI)\n#pld_edges_df2=spark.read.load(edgesURI)\n#print(pld_edges_df2.rdd.getNumPartitions())\nprint(\"Code to load/save.\")","user":"anonymous","dateUpdated":"2017-12-01T16:37:29+0000","config":{"colWidth":12,"editorMode":"ace/mode/python","results":{},"enabled":true,"editorSetting":{"language":"python","editOnDblClick":false}},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"Code to load/save.\n"}]},"apps":[],"jobName":"paragraph_1512145645971_773762469","id":"20171102-135417_1202091008","dateCreated":"2017-12-01T16:27:25+0000","dateStarted":"2017-12-01T16:37:29+0000","dateFinished":"2017-12-01T16:37:29+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:3649"},{"text":"%pyspark\n\n# Next use reduceByKey to aggregate and ensure no more than 10 per PLD - note we create a list for the map values (then + appends)\nout_schema = StructType([StructField('PLDout', StringType(), False),StructField('exampleOutLinkPlds', StringType(), False)])\nout_degree_examples_df=pld_edges_df2.rdd.map(lambda x:(x['PLD_src'],[x['PLD_dst']])).reduceByKey(lambda acc,pld: acc if len(acc)>=10 else acc+pld).toDF(out_schema) \nout_degree_examples_df.show(10)\n\n# Note that the below also works but not sure how to restrict to only 10 IDs per PLD:\n#from pyspark.sql.functions import collect_list\n#out_degree_examples=pld_edges_df.groupBy(\"src\").agg(collect_list(\"dst\"))","user":"anonymous","dateUpdated":"2017-12-01T16:37:36+0000","config":{"colWidth":12,"editorMode":"ace/mode/python","results":{},"enabled":true,"editorSetting":{"language":"python","editOnDblClick":false}},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"+--------------------+--------------------+\n|              PLDout|  exampleOutLinkPlds|\n+--------------------+--------------------+\n|        timesnews.gr|[gtyo.org, issuu....|\n|     livoloeurope.eu|[bpostbank.be, ma...|\n|    indiandogsfam.nl|          [ziggo.nl]|\n|hotel-im-kaiserpa...|[meiningen.de, wa...|\n|        eu-brein.com|[upenn.edu, googl...|\n|constructeur-mais...|    [bookmyname.com]|\n|naturefocusthaila...|[googleapis.com, ...|\n|         eyoc2016.pl|    [aftermarket.pl]|\n|         ladanse.com|[cccommunication....|\n|concertsatfirstch...|[google.com, goog...|\n+--------------------+--------------------+\nonly showing top 10 rows\n\n"}]},"apps":[],"jobName":"paragraph_1512145645971_773762469","id":"20171027-140940_62611545","dateCreated":"2017-12-01T16:27:25+0000","dateStarted":"2017-12-01T16:37:36+0000","dateFinished":"2017-12-01T16:50:18+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:3650"},{"text":"%pyspark\n\n# Now do the same for in-degrees\nin_schema = StructType([StructField('PLDin', StringType(), False),StructField('exampleInLinkPlds', StringType(), False)])\nin_degree_examples_df=pld_edges_df2.rdd.map(lambda x:(x['PLD_dst'],[x['PLD_src']])).reduceByKey(lambda acc,pld: acc if len(acc)>=10 else acc+pld).toDF(in_schema)   \nin_degree_examples_df.show(10)\npld_edges_df2.unpersist() # Don't need this any more","user":"anonymous","dateUpdated":"2017-12-01T16:37:41+0000","config":{"colWidth":12,"editorMode":"ace/mode/python","results":{},"enabled":true,"editorSetting":{"language":"python","editOnDblClick":false}},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"+--------------------+--------------------+\n|               PLDin|   exampleInLinkPlds|\n+--------------------+--------------------+\n|        bbnation.biz|[list-of-domains....|\n|    affiche-blog.com|[urlmetriques.co,...|\n|    mkuqzkucovuf.com|            [vgb.no]|\n| askaboutfashion.com|[ldblog.jp, debat...|\n|myplannercolibri....|  [myplanner.com.br]|\n|        eu-brein.com|[triphp.com, ogf....|\n|  bscsolutions.co.uk|[communig8.com, h...|\n|  roarkinsurance.net|      [blogspot.com]|\n|      unlockarea.com|[icyphoenix.it, f...|\n|         e-tanita.jp|[psta.jp, yamaha....|\n+--------------------+--------------------+\nonly showing top 10 rows\n\nDataFrame[PLD_src: string, PLD_dst: string]\n"}]},"apps":[],"jobName":"paragraph_1512145645971_773762469","id":"20171102-120823_1325716344","dateCreated":"2017-12-01T16:27:25+0000","dateStarted":"2017-12-01T16:37:41+0000","dateFinished":"2017-12-01T16:56:13+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:3651"},{"text":"%pyspark\n\n# Join the In/Out-Link examples together\npld_df_joined=out_degree_examples_df.join(in_degree_examples_df, out_degree_examples_df.PLDout==in_degree_examples_df.PLDin, \"outer\").drop(\"PLDout\")\nout_degree_examples_df.unpersist()\nin_degree_examples_df.unpersist()\npld_df_joined.show(5)\npld_df_joined.cache()\npld_df_joined.count() # Should still be 94M","user":"anonymous","dateUpdated":"2017-12-01T16:37:51+0000","config":{"colWidth":12,"editorMode":"ace/mode/python","results":{},"enabled":true,"editorSetting":{"language":"python","editOnDblClick":false}},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"+--------------------+--------------------+--------------------+\n|  exampleOutLinkPlds|               PLDin|   exampleInLinkPlds|\n+--------------------+--------------------+--------------------+\n|                null|0----------------...|         [nomina.ru]|\n|                null|0--0-------------...|           [yapl.ru]|\n|                null|0--0------a4--bbb...|           [yapl.ru]|\n|[gmpg.org, google...|           0-0la.com|[artathina.gr, fa...|\n|                null|            0-1du.cn|            [39.net]|\n+--------------------+--------------------+--------------------+\nonly showing top 5 rows\n\n93034556\n"}]},"apps":[],"jobName":"paragraph_1512145645971_773762469","id":"20171030-112424_1733367457","dateCreated":"2017-12-01T16:27:25+0000","dateStarted":"2017-12-01T16:50:18+0000","dateFinished":"2017-12-01T16:57:54+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:3652"},{"text":"%pyspark\n\n# Save the in-out examples to S3 so we can just load them next time, and avoid the above expensive processing!\n#pld_df_joined2=pld_df_joined.select(\"PLDin\",\"exampleInLinkPlds\",\"exampleOutLinkPlds\").withColumnRenamed(\"PLDin\",\"PLD\")\nlinkExamplesURI=\"s3://billsdata.net/CommonCrawl/domain_examples_links_new/\"\n#pld_df_joined.write.save(linkExamplesURI)\npld_df_joined=spark.read.load(linkExamplesURI)\nprint(pld_df_joined.rdd.getNumPartitions())","user":"anonymous","dateUpdated":"2017-12-01T18:02:03+0000","config":{"colWidth":12,"editorMode":"ace/mode/python","results":{},"enabled":true,"editorSetting":{"language":"python","editOnDblClick":false}},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"200\n"}]},"apps":[],"jobName":"paragraph_1512145645971_773762469","id":"20171025-075140_290274377","dateCreated":"2017-12-01T16:27:25+0000","dateStarted":"2017-12-01T16:56:14+0000","dateFinished":"2017-12-01T17:02:43+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:3653"},{"text":"%pyspark\n\n# Next, we'll construct a local dictionary from of all the PLDS (key is the PLD, value is the ID)\n# This is our truth-table of known PLDs that we'll use when extracting host examples\n\n# Create a bloom filter using a pure python package (might be a little slow)\nfrom pybloom import BloomFilter\npld_bf = BloomFilter(capacity=94000000, error_rate=0.005)\n\nfor row in pld_df.rdd.collect(): #.take(10000): # limit(10000000) # TODO: Still bad (and exceeds spark.driver.maxResultSize with all rows)!\n    pld_bf.add(row['PLD'])\n\n#print(pld_df.rdd.take(3))\n#print(pld_df.rdd.take(3)[2]['PLD'])\nprint(\"aaa.aaa\" in pld_bf) # Should be True\n\nimport sys\nprint(sys.getsizeof(pld_bf))\nprint(len(pld_bf)) # Should match number of items entered\n\n# Broadcast the bloom filter so it's available on all the slave nodes - we don't need to change\n# it any more so it's fine being immutable.\npld_bf_distrib=sc.broadcast(pld_bf)\n\nprint(\"aaa.aaa\" in pld_bf) # Should be true\nprint(\"aaa.aaa.bla\" in pld_bf) # Should be false\nprint(\"aaa.aaa\" in pld_bf_distrib.value) # Should be true\nprint(\"aaa.aaa.bla\" in pld_bf_distrib.value) # Should be false","user":"anonymous","dateUpdated":"2017-12-01T16:38:49+0000","config":{"colWidth":12,"editorMode":"ace/mode/python","results":{},"enabled":true,"editorSetting":{"language":"python","editOnDblClick":false}},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1512145645971_773762469","id":"20170929-100048_2070118110","dateCreated":"2017-12-01T16:27:25+0000","dateStarted":"2017-12-01T16:57:55+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:3654","results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"True\n64\n93110180\nTrue\nFalse\nTrue\nFalse\n"}]},"dateFinished":"2017-12-01T17:28:51+0000"},{"text":"%pyspark\n\n# Returns a Boolean to say whether PLD is a hostname in itself\ndef is_a_pld(hostname):\n    #if hostname in pld_lookup_table:\n    #if pld_lookup_table.filter(lambda a: a == hostname).count()>0:\n    if hostname in pld_bf_distrib.value:\n        return True\n    else:\n        return False\n\n# Function to do the hostname->pld conversion, if the reversed pld exists in our dictionary \ndef convert_hostname(hostname):\n    # Return hostname as-is, if this is already a PLD\n    #if hostname in pld_lookup_table:\n    #if pld_lookup_table.filter(lambda a: a == hostname).count()>0:\n    if hostname in pld_bf_distrib.value:\n        return hostname\n    # Otherwise we're going to have to split it up and test the parts\n    try:\n        parts=hostname.split('.')\n        if (len(parts)>4 and is_a_pld('.'.join(parts[0:4]))):\n            return '.'.join(parts[0:4])\n        if (len(parts)>3 and is_a_pld('.'.join(parts[0:3]))):\n            return '.'.join(parts[0:3])\n        if (len(parts)>2 and is_a_pld('.'.join(parts[0:2]))):\n            return '.'.join(parts[0:2])\n        if (len(parts)>1 and is_a_pld('.'.join(parts[0:1]))):\n            return '.'.join(parts[0:1])\n        return \"ERROR\" # Couldn't find a corresponding PLD - this should never happen!\n    except:\n        return \"ERROR\"\n        \n# Test\nprint(convert_hostname(\"aaa.aaa\"))\nprint(is_a_pld(\"aaa.aaa\")) # Should be true","user":"anonymous","dateUpdated":"2017-12-01T16:38:53+0000","config":{"colWidth":12,"editorMode":"ace/mode/python","results":{},"enabled":true,"editorSetting":{"language":"python","editOnDblClick":false}},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1512145645972_771838725","id":"20171004-091447_4214261","dateCreated":"2017-12-01T16:27:25+0000","dateStarted":"2017-12-01T17:02:44+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:3655","results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"aaa.aaa\nTrue\n"}]},"dateFinished":"2017-12-01T17:28:51+0000"},{"text":"%pyspark\n\n# Generate 10 host examples per PLD.\n\n# Firstly, define a reverse domain function\ndef reverse_domain(domain):\n    return '.'.join(reversed(domain.split('.')))\nprint(reverse_domain(\"com.facebook\"))\n#udf_reverse_domain = udf(reverse_domain, StringType())\n\n# Now reverse all host names after conversion to PLDs (including lookup) but prior to summarization.\n#host_example_rdd=unrev_host_df.rdd.map(lambda x: (convert_hostname(x['host']),[x['host']])).reduceByKey(lambda acc,host: acc if len(acc)>=10 else acc+host)\nhost_example_rdd=host_df.rdd.map(lambda x: (reverse_domain(convert_hostname(x['host'])),[reverse_domain(x['host'])])).reduceByKey(lambda acc,host: acc if len(acc)>=10 else acc+host)\nprint(host_example_rdd.take(20))\n\n#print(host_example_rdd.count())\n#host_df.unpersist()","user":"anonymous","dateUpdated":"2017-12-01T16:39:00+0000","config":{"colWidth":12,"editorMode":"ace/mode/python","results":{},"enabled":true,"editorSetting":{"language":"python","editOnDblClick":false}},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"facebook.com\n[(u'trachten-sz.ch', [u'trachten-sz.ch']), (u'aiefootwear.com', [u'aiefootwear.com']), (u'ancfe.it', [u'ancfe.it']), (u'householdstaffing.agency', [u'householdstaffing.agency']), (u'mywpm.com', [u'zdunex25.mywpm.com']), (u'koikoikoi.de', [u'koikoikoi.de']), (u'residencedealexandris.fr', [u'residencedealexandris.fr']), (u'mataami.ma', [u'mataami.ma']), (u'diyworkouts.com', [u'diyworkouts.com']), (u'fairmind.tk', [u'fairmind.tk']), (u'spcaofpolkcounty.org', [u'spcaofpolkcounty.org']), (u'restaurantdurmitor.com', [u'restaurantdurmitor.com']), (u'fggo5.biz', [u'relate1.fggo5.biz', u'relate6.fggo5.biz', u'relate8.fggo5.biz', u'relate9.fggo5.biz']), (u'motorvation.biz', [u'motorvation.biz']), (u'agapelive.co.za', [u'agapelive.co.za']), (u'daveandpring.com', [u'daveandpring.com']), (u'theserahspace.com', [u'theserahspace.com']), (u'ezlenderforms.com', [u'ezlenderforms.com']), (u'onyourfeetministries.com', [u'onyourfeetministries.com']), (u'imcbrd.ac.cn', [u'imcbrd.ac.cn'])]\n"}]},"apps":[],"jobName":"paragraph_1512145645972_771838725","id":"20171004-092350_1522843259","dateCreated":"2017-12-01T16:27:25+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:3656","dateFinished":"2017-12-01T17:57:15+0000","dateStarted":"2017-12-01T17:28:51+0000"},{"text":"%pyspark\n\n#print(host_example_rdd.take(100))\n\n# Convert host examples back to a dataframe\nout_schema = StructType([StructField('PLD', StringType(), False),StructField('exampleHosts', StringType(), False)])\nhost_examples_df=host_example_rdd.toDF(out_schema) \nhost_examples_df.show(100)","user":"anonymous","dateUpdated":"2017-12-01T16:39:05+0000","config":{"colWidth":12,"editorMode":"ace/mode/python","results":{},"enabled":true,"editorSetting":{"language":"python","editOnDblClick":false}},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"+--------------------+--------------------+\n|                 PLD|        exampleHosts|\n+--------------------+--------------------+\n|           4lapi.biz|         [4lapi.biz]|\n| goiabaonline.com.br|[goiabaonline.com...|\n|householdstaffing...|[householdstaffin...|\n|           mywpm.com|[zdunex25.mywpm.com]|\n|        koikoikoi.de|      [koikoikoi.de]|\n|residencedealexan...|[residencedealexa...|\n|  roarkinsurance.net|[roarkinsurance.net]|\n|      unlockarea.com|    [unlockarea.com]|\n|       caffericci.fr|     [caffericci.fr]|\n|         fairmind.tk|       [fairmind.tk]|\n|restaurantdurmito...|[restaurantdurmit...|\n|austinstarroofing...|[austinstarroofin...|\n|     agapelive.co.za|   [agapelive.co.za]|\n|    daveandpring.com|  [daveandpring.com]|\n|        jercyltd.com|      [jercyltd.com]|\n|        imcbrd.ac.cn|      [imcbrd.ac.cn]|\n|         bonnwcc.com|       [bonnwcc.com]|\n|freebannergenerat...|[freebannergenera...|\n|    benzkiimages.com|  [benzkiimages.com]|\n| cleverlyeleanor.com|[cleverlyeleanor....|\n|recantofonteluz.c...|[recantofonteluz....|\n| f1helpsolutions.com|[f1helpsolutions....|\n|            dobbl.no|          [dobbl.no]|\n|           2ookin.de|         [2ookin.de]|\n|       gpdvewpux.xyz|     [gpdvewpux.xyz]|\n|     webmastrdima.ru|   [webmastrdima.ru]|\n|        inndeknip.nl|      [inndeknip.nl]|\n|      soulsession.hu|    [soulsession.hu]|\n|       road-games.ru|     [road-games.ru]|\n|    leedsmagic.co.uk|  [leedsmagic.co.uk]|\n|applebychildcare....|[applebychildcare...|\n|          cultlib.ru|        [cultlib.ru]|\n|apartamentedevanz...|[apartamentedevan...|\n|   artfleederman.com| [artfleederman.com]|\n|    xn--trfix-tra.dk|  [xn--trfix-tra.dk]|\n|       ptmarquees.ie|     [ptmarquees.ie]|\n|ratedapartments.c...|[ratedapartments....|\n|    poshsalonwbg.com|  [poshsalonwbg.com]|\n|oakstoneapartment...|[oakstoneapartmen...|\n|          isezusi.jp|        [isezusi.jp]|\n|           917av.com|         [917av.com]|\n|   botwinikmusic.com| [botwinikmusic.com]|\n|urbatek-promotion.fr|[urbatek-promotio...|\n|  courtingbertha.com|[courtingbertha.c...|\n|braindripperprodu...|[braindripperprod...|\n|   fcdekampioenen.nl| [fcdekampioenen.nl]|\n| jamesovidmustin.com|[jamesovidmustin....|\n| bertram-guenther.de|[bertram-guenther...|\n| innhouseflorist.com|[innhouseflorist....|\n|         birkin.info|[birkin.info, tie...|\n|        paulleim.com|      [paulleim.com]|\n| hardbargainfarm.org|[hardbargainfarm....|\n|   rickyaiellojr.com| [rickyaiellojr.com]|\n|    dcefyljhrpnv.com|  [dcefyljhrpnv.com]|\n|  harshchemicals.com|[harshchemicals.com]|\n|  inquirymaths.co.uk|[inquirymaths.co.uk]|\n|        vesisorb.com|      [vesisorb.com]|\n|    ashlynweiner.com|  [ashlynweiner.com]|\n|aerialeequipment.com|[aerialeequipment...|\n|  hmsauer-schrift.de|[hmsauer-schrift.de]|\n|kelloggsummersoir...|[kelloggsummersoi...|\n|    dumbartonaac.com|  [dumbartonaac.com]|\n|   vermonsterfit.com| [vermonsterfit.com]|\n|          zrptt.info|[0btjl.zrptt.info...|\n| house-warming.co.kr|[house-warming.co...|\n|        ocherish.com|      [ocherish.com]|\n|highschoolbusines...|[highschoolbusine...|\n|      adb-konsult.se|    [adb-konsult.se]|\n|        sulfurmag.eu|      [sulfurmag.eu]|\n|    voc-advocaten.nl|  [voc-advocaten.nl]|\n|    docsbirddogs.com|  [docsbirddogs.com]|\n|      khanehjavan.ir|    [khanehjavan.ir]|\n|    mindfulnessdk.dk|  [mindfulnessdk.dk]|\n|        rileynam.com|      [rileynam.com]|\n|         lozanos.net|       [lozanos.net]|\n|          twfish.net|        [twfish.net]|\n|  ldpr-atributika.ru|[ldpr-atributika.ru]|\n|          fnckjc.com|        [fnckjc.com]|\n|   gerard-theisen.lu| [gerard-theisen.lu]|\n|        senai.gov.br|      [senai.gov.br]|\n|        meisenkai.jp|[meisenkai.jp, bl...|\n|    gocreditshop.com|  [gocreditshop.com]|\n|    qqycvmzwnefh.com|  [qqycvmzwnefh.com]|\n|            wfmt.org|          [wfmt.org]|\n|         taosesc.com|       [taosesc.com]|\n|          djphys.org|        [djphys.org]|\n|risel-industries....|[risel-industries...|\n|  silverestrella.com|[silverestrella.com]|\n|       ccgretail.com|     [ccgretail.com]|\n| grandcherokeezj.com|[grandcherokeezj....|\n|       pranapath.org|     [pranapath.org]|\n|bestbelgiumchocol...|[bestbelgiumchoco...|\n|     implant8.com.tw|   [implant8.com.tw]|\n|newerapublication...|[newerapublicatio...|\n|     sindyeugene.com|   [sindyeugene.com]|\n|glenvalecanvas.co...|[glenvalecanvas.c...|\n|       xydyzwzzs.com|     [xydyzwzzs.com]|\n|      best-mother.jp|    [best-mother.jp]|\n|   photoddgraphy.org| [photoddgraphy.org]|\n|   footsiestools.org| [footsiestools.org]|\n+--------------------+--------------------+\nonly showing top 100 rows\n\n"}]},"apps":[],"jobName":"paragraph_1512145645972_771838725","id":"20171027-113721_1699720093","dateCreated":"2017-12-01T16:27:25+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:3657","dateFinished":"2017-12-01T17:57:16+0000","dateStarted":"2017-12-01T17:28:51+0000"},{"text":"%pyspark\n\n# Join in/out-link summaries with host examples dataframe\nexample_df=pld_df_joined.join(host_examples_df, pld_df_joined.PLDin==host_examples_df.PLD, \"outer\").drop(\"PLDin\").select(\"PLD\",\"exampleHosts\",\"exampleInLinkPlds\",\"exampleOutLinkPlds\")\nexample_df.show(100)\nexample_df.cache()\nexample_df.count() # Should still be 91M!","user":"anonymous","dateUpdated":"2017-12-01T16:39:11+0000","config":{"colWidth":12,"editorMode":"ace/mode/python","results":{},"enabled":true,"editorSetting":{"language":"python","editOnDblClick":false}},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"+--------------------+--------------------+--------------------+--------------------+\n|                 PLD|        exampleHosts|   exampleInLinkPlds|  exampleOutLinkPlds|\n+--------------------+--------------------+--------------------+--------------------+\n|0----------------...|[0---------------...|         [nomina.ru]|                null|\n|0--0-------------...|[0--0------------...|           [yapl.ru]|                null|\n|0--0------a4--bbb...|[0--0------a4--bb...|           [yapl.ru]|                null|\n|           0-0la.com|         [0-0la.com]|[artathina.gr, fa...|[gmpg.org, wordpr...|\n|            0-1du.cn|          [0-1du.cn]|            [39.net]|                null|\n|           0-3-6.com|         [0-3-6.com]|[8beauty.com, 211...|                null|\n|           0-3ani.ro|         [0-3ani.ro]|[adedir.info, cer...|                null|\n|           0-5-1.com|         [0-5-1.com]|    [allthecom.info]|                null|\n|       0-60times.net|     [0-60times.net]|[blogspot.com, wz...|                null|\n|            0-744.cn|          [0-744.cn]|     [wordpress.com]|                null|\n|0-ads-free-web-pa...|[0-ads-free-web-p...|[blackmagic.org, ...|                null|\n|       0-artlove.net|     [0-artlove.net]|[list-of-domains....|                null|\n|  0-clubpenguin-0.tk|[0-clubpenguin-0.tk]|[similarsites.com...|                null|\n|      0-dc-ao1-0.com|    [0-dc-ao1-0.com]|    [allthecom.info]|                null|\n|        0-estate.com|      [0-estate.com]|[list-of-domains....|                null|\n|0-interest-credit.cn|[credit-fixed-rat...|           [fc2.com]|                null|\n|          0-mode.com|        [0-mode.com]|    [allthecom.info]|                null|\n|0-nline-college-s...|[0-nline-college-...|    [blackmagic.org]|                null|\n|   0-pointsloans.com| [0-pointsloans.com]|    [blackmagic.org]|                null|\n|            0-seo.ru|          [0-seo.ru]|    [visualideas.ru]|                null|\n|         0-space.com|       [0-space.com]|[jugem.jp, list-o...|                null|\n|            0-sx.org|          [0-sx.org]|[list-of-domains....|                null|\n|           00-am.net|         [00-am.net]|[list-of-domains....|                null|\n|            00-p.net|          [00-p.net]|[list-of-domains....|                null|\n|          000-001.us|        [000-001.us]|[list-of-domains....|                null|\n|         000-115.com|[aw48wj.000-115.c...|      [yvesbady.com]|                null|\n|             0000.it|           [0000.it]|     [dropgrabs.com]|[previsionideltem...|\n|        00000005.com|      [00000005.com]|[list-of-domains....|                null|\n|000000broomstick2...|[000000broomstick...|[list-of-domains....|                null|\n| 000000exchange.info|[000000exchange.i...|[list-of-domains....|                null|\n|     000000globo.com|   [000000globo.com]|[list-of-domains....|                null|\n|        000000ly.org|      [000000ly.org]|[list-of-domains....|                null|\n|        000000mc.biz|      [000000mc.biz]|[list-of-domains....|                null|\n|  000000orvegas.info|[000000orvegas.info]|[list-of-domains....|                null|\n|     000000t0000z.nr|[fgon8.3.sm.09032...|[midatlanticweath...|                null|\n|         0000086.net|       [0000086.net]|    [allthecom.info]|                null|\n|        00000wee.com|      [00000wee.com]|[list-of-domains....|                null|\n|     0000111ccbs.com|   [0000111ccbs.com]|[list-of-domains....|                null|\n|          00006h.com|        [00006h.com]|[rankank.com, sit...|                null|\n|       0000music.com|     [0000music.com]|    [blackmagic.org]|                null|\n|            00019.us|          [00019.us]|[list-of-domains....|                null|\n|       000celebs.com|     [000celebs.com]|    [blackmagic.org]|                null|\n|000placestoseebef...|[000placestoseebe...|[list-of-domains....|                null|\n|        000waves.com|      [000waves.com]|     [logontube.com]|                null|\n|      00100pizza.com|    [00100pizza.com]|[eatingitalyfoodt...|                null|\n|00123-penis-enlar...|[00123-penis-enla...|          [forum.hr]|                null|\n|          001340.org|        [001340.org]|[list-of-domains....|                null|\n|0013c538ictures.info|[0013c538ictures....|[list-of-domains....|                null|\n|         001baby.com|       [001baby.com]|         [ysyyw.com]|                null|\n|          001bdf.com|[000jdi.001bdf.co...|[029chuguo.com, 9...|[lampicka.com, qr...|\n|         001free.net|       [001free.net]|[heiha.net, luson...|                null|\n|         001hmzz.com|       [001hmzz.com]|         [heiha.net]|                null|\n|   001musicvideo.net| [001musicvideo.net]|[list-of-domains....|                null|\n|            001nl.cn|[001nl.cn, 1n5g.0...|[anfnnd.cn, hg022...|                null|\n|           001s8.com|         [001s8.com]|       [rankank.com]|                null|\n|         001wine.com|       [001wine.com]|    [blackmagic.org]|                null|\n|             001x.pw|        [hk.001x.pw]|[df6x.us, 10028.i...|                null|\n|            001xs.cn|          [001xs.cn]|         [heiha.net]|                null|\n|          002097.org|        [002097.org]|[list-of-domains....|                null|\n|       00228vip5.com|     [00228vip5.com]|      [www00228.com]|[macromedia.com, ...|\n|          00271.info|        [00271.info]|    [geoipfacts.com]|                null|\n|          002955.com|[002955.com, 047d...|[5137999.com, 159...|[hongliemiye.com,...|\n|          002cmp.com|        [002cmp.com]|[083875.com, rank...|                null|\n|          003399.com|        [003399.com]|[heiha.net, w3db....|                null|\n|         0038com.com|       [0038com.com]|                null|                null|\n|             0039.ws|           [0039.ws]|       [rankank.com]|                null|\n|0039communication...|[0039communicatio...|[list-of-domains....|                null|\n|       0039group.org|     [0039group.org]|[list-of-domains....|                null|\n|         0039moda.it|       [0039moda.it]| [domainregister.it]|                null|\n|          00404.info|        [00404.info]|[list-of-domains....|                null|\n|  00423664233130.com|[00423664233130.com]|[list-of-domains....|                null|\n|           0043.info|         [0043.info]|[geoipfacts.com, ...|                null|\n|        004zb.com.cn|      [004zb.com.cn]|       [452222.info]|                null|\n|           00500.net|[00500.net, cs.00...|[777b.cc, sonnens...|                null|\n|          0051234.ru|        [0051234.ru]|[go-cz.ru, rankan...|[youtube.com, goo...|\n|          005598.com|        [005598.com]|[list-of-domains....|                null|\n|  0059kcom.ynylx.com|[0059kcom.ynylx.com]|                null|                null|\n|       006.xn--p1acf|[xn--80aaahmntdsh...|[yobuntik.ru, ant...|                null|\n|           00688.com|         [00688.com]|    [blackmagic.org]|                null|\n|           0068e.com|[0068e.com, mengz...|[looktiqueblog.co...|                null|\n|          006sex.com|        [006sex.com]|    [blackmagic.org]|                null|\n|              007.de|            [007.de]|[tapefactory.de, ...|[sompex.de, plent...|\n|        007007007.eu|      [007007007.eu]|[blogspot.com, on...|                null|\n|           0073.info|         [0073.info]|[ippraisal.com, l...|                null|\n|            00744.ru|          [00744.ru]|[mynuke.ru, moddb...|[indiedb.com, ope...|\n|            00775.cn|          [00775.cn]|[03198.cn, 58282.cn]|                null|\n|          00778a.com|        [00778a.com]|       [rankank.com]|                null|\n|          007bbs.com|        [007bbs.com]|         [heiha.net]|                null|\n|    007bond-lady.com|  [007bond-lady.com]|     [logontube.com]|                null|\n|     007cartoons.net|   [007cartoons.net]|[list-of-domains....|                null|\n|           007cf.com| [filesqh.007cf.com]|[tiempologistico....|                null|\n|      007diaocha.com|    [007diaocha.com]|     [logontube.com]|                null|\n|           007dom.ru|[007dom.ru, mosco...|[zamos.ru, 8lap.r...|[komnata.info, fc...|\n|          007dvr.com|        [007dvr.com]|[blackmagic.org, ...|                null|\n|   007flashgames.net| [007flashgames.net]|[list-of-domains....|                null|\n|            007it.ca|          [007it.ca]|[clearlineselfsto...|                null|\n|         007legs.com|       [007legs.com]|[timway.com, blac...|                null|\n|        007lotto.com|      [007lotto.com]|[kapook.com, rhon...|[blogblog.com, im...|\n|    007lovessex.info|  [007lovessex.info]|[list-of-domains....|                null|\n|      007pajamas.com|    [007pajamas.com]|[list-of-domains....|                null|\n+--------------------+--------------------+--------------------+--------------------+\nonly showing top 100 rows\n\n98315210\n"}]},"apps":[],"jobName":"paragraph_1512145645972_771838725","id":"20171012-142038_800861977","dateCreated":"2017-12-01T16:27:25+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:3658","dateFinished":"2017-12-01T17:58:54+0000","dateStarted":"2017-12-01T17:57:15+0000"},{"text":"%pyspark\n\n# Save final table to S3 in parquet format, broken into smaller files (for fast reading into Paul 7 that will combine original summaries with examples)\noutputURI=\"s3://billsdata.net/CommonCrawl/domain_examples4new/\"\n#codec=\"org.apache.hadoop.io.compress.GzipCodec\"\n#example_df.write.format('com.databricks.spark.csv').options(header='true', codec=codec).save(outputURI) # Single GZIP initially for debugging\nexample_df.write.save(outputURI)","user":"anonymous","dateUpdated":"2017-12-01T16:39:23+0000","config":{"colWidth":12,"editorMode":"ace/mode/python","results":{},"enabled":true,"editorSetting":{"language":"python","editOnDblClick":false}},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[]},"apps":[],"jobName":"paragraph_1512145645972_771838725","id":"20171018-175711_441001507","dateCreated":"2017-12-01T16:27:25+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:3659","dateFinished":"2017-12-01T18:04:32+0000","dateStarted":"2017-12-01T17:57:16+0000"},{"text":"%pyspark\n","dateUpdated":"2017-12-01T16:27:25+0000","config":{"colWidth":12,"editorMode":"ace/mode/python","results":{},"enabled":true,"editorSetting":{"language":"python","editOnDblClick":false}},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1512145645972_771838725","id":"20171027-094657_452033266","dateCreated":"2017-12-01T16:27:25+0000","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:3660"}],"name":"Paul 6 - examples for domain summary","id":"2D2MBBS6X","angularObjects":{"2BRWU4WXC:shared_process":[],"2AM1YV5CU:shared_process":[],"2AJXGMUUJ:shared_process":[],"2ANGGHHMQ:shared_process":[],"2AKK3QQXU:shared_process":[]},"config":{"looknfeel":"default","personalizedMode":"false"},"info":{}}